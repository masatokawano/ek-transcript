# 要件定義書

## 1. プロジェクト概要

### 1.1 背景

現在の ek-transcript システムでは、ユーザーが手動で動画ファイルをアップロードする必要があります。Google Meet との統合により、会議の録画から分析までを完全自動化し、ユーザーの作業負担を大幅に削減します。

### 1.2 目的

- Google Calendar で設定した会議の自動録画
- 録画完了後の自動分析パイプライン実行
- シームレスな会議→分析フローの実現

### 1.3 スコープ

**対象:**
- Google Workspace Business Standard 以上のアカウント
- Google Meet で開催される会議
- HEMS インタビュー分析

**対象外:**
- Zoom, Microsoft Teams など他のビデオ会議サービス
- @gmail.com（無料アカウント）での録画

---

## 2. 機能要件

### 2.1 Google アカウント連携

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-001 | ユーザーは Google アカウントでログインできる | 必須 |
| FR-002 | システムは必要な OAuth スコープの同意を取得する | 必須 |
| FR-003 | アクセストークンの自動更新が行われる | 必須 |
| FR-004 | ユーザーは Google 連携を解除できる | 必須 |

### 2.2 カレンダー連携

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-010 | システムはユーザーの Google Calendar イベントを取得できる | 必須 |
| FR-011 | ユーザーは会議一覧を閲覧できる | 必須 |
| FR-012 | ユーザーは新規会議を作成できる（Meet リンク付き） | 必須 |
| FR-013 | ユーザーは既存の会議に自動録画設定を適用できる | 必須 |
| FR-014 | システムは定期的にカレンダーを同期する | 必須 |
| FR-015 | ユーザーは会議ごとに分析対象かどうかを設定できる | 推奨 |

### 2.3 自動録画設定

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-020 | システムは Meet Space に auto-recording を設定できる | 必須 |
| FR-021 | システムは auto-transcription を設定できる | 推奨 |
| FR-022 | 設定は会議開始前に完了している必要がある | 必須 |
| FR-023 | ユーザーは一括で複数会議に設定を適用できる | 推奨 |

### 2.4 録画イベント処理

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-030 | システムは録画完了イベントを受信できる | 必須 |
| FR-031 | 録画完了後、自動的に Google Drive から録画を取得する | 必須 |
| FR-032 | 録画ファイルを S3 にアップロードする | 必須 |
| FR-033 | 既存の Step Functions パイプラインを起動する | 必須 |
| FR-034 | 処理状況をリアルタイムで表示する | 推奨 |

### 2.5 分析結果表示

| ID | 要件 | 優先度 |
|----|------|--------|
| FR-040 | 会議と分析結果を紐付けて表示する | 必須 |
| FR-041 | カレンダービューで分析済み会議を確認できる | 推奨 |
| FR-042 | 会議メタデータ（参加者、時間など）を表示する | 推奨 |

---

## 3. 非機能要件

### 3.1 パフォーマンス

| ID | 要件 | 指標 |
|----|------|------|
| NFR-001 | カレンダー同期は5分以内に完了する | 同期時間 < 5分 |
| NFR-002 | 録画ダウンロード開始は通知から1分以内 | 遅延 < 60秒 |
| NFR-003 | 1GB の録画ファイルダウンロードは10分以内 | スループット > 1.7 MB/s |

### 3.2 可用性

| ID | 要件 | 指標 |
|----|------|------|
| NFR-010 | イベント通知の取りこぼしがない | 成功率 > 99.9% |
| NFR-011 | システムは24時間365日稼働する | 稼働率 > 99.5% |
| NFR-012 | 一時的な障害時はリトライを行う | 最大3回リトライ |

### 3.3 スケーラビリティ

| ID | 要件 | 指標 |
|----|------|------|
| NFR-020 | 同時に10件の録画ダウンロードを処理できる | 並列処理数 >= 10 |
| NFR-021 | ユーザー数100人をサポートする | 初期ターゲット |
| NFR-022 | 録画ファイルサイズ最大10GBをサポート | ファイルサイズ上限 |

### 3.4 セキュリティ

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-030 | OAuth トークンは暗号化して保存する | AWS Secrets Manager 使用 |
| NFR-031 | API 通信は TLS 1.2 以上を使用する | HTTPS 必須 |
| NFR-032 | 最小権限の原則に従う | 必要最小限のスコープ |
| NFR-033 | 監査ログを記録する | CloudWatch Logs |

### 3.5 運用性

| ID | 要件 | 詳細 |
|----|------|------|
| NFR-040 | エラー発生時にアラートを送信する | CloudWatch Alarms |
| NFR-041 | メトリクスを収集する | 処理件数、エラー率等 |
| NFR-042 | ログは30日間保持する | CloudWatch Logs 保持期間 |

---

## 4. 制約事項

### 4.1 Google Workspace 制約

| 制約 | 詳細 |
|------|------|
| エディション要件 | Business Standard 以上が必要 |
| 録画時間制限 | 1セッションあたり最大8時間 |
| ストレージ依存 | 録画は組織の Google Drive に保存される |
| 生成時間 | 録画ファイル生成に数分〜数十分かかる場合あり |

### 4.2 技術的制約

| 制約 | 詳細 |
|------|------|
| リアルタイム不可 | 会議中の音声・映像にはAPIでアクセス不可 |
| 録画開始操作 | Auto-recording 設定が必要（手動開始はAPI不可） |
| イベント遅延 | Pub/Sub 通知に数秒〜数分の遅延あり |

### 4.3 運用制約

| 制約 | 詳細 |
|------|------|
| 初回設定 | Google Workspace 管理者による API 有効化が必要 |
| ドメイン全体の委任 | サービスアカウント使用時に必要 |

---

## 5. 前提条件

1. ユーザーは Google Workspace Business Standard 以上のアカウントを持つ
2. Google Workspace 管理者が必要な API を有効化している
3. ユーザーは会議の主催者または録画権限を持つ
4. 組織の Google Drive に十分なストレージ容量がある
5. AWS アカウントと既存の ek-transcript インフラが稼働している

---

## 6. ユースケース

### UC-001: 新規会議の自動録画設定

**アクター:** ユーザー

**前提条件:**
- ユーザーは Google アカウントでログイン済み
- カレンダー権限を許可済み

**基本フロー:**
1. ユーザーが「新規会議作成」をクリック
2. 会議タイトル、日時、参加者を入力
3. 「自動録画を有効にする」をチェック
4. 「作成」をクリック
5. システムが Google Calendar にイベントを作成
6. システムが Meet Space に auto-recording を設定
7. 確認画面を表示

**代替フロー:**
- 4a. Meet Space 設定に失敗した場合、エラーを表示し再試行オプションを提供

### UC-002: 録画完了後の自動分析

**アクター:** システム（自動）

**トリガー:** 録画ファイル生成完了イベント

**基本フロー:**
1. Pub/Sub から録画完了イベントを受信
2. Meet API から録画情報を取得
3. Drive API から録画ファイルをダウンロード
4. S3 にアップロード
5. DynamoDB にメタデータを保存
6. Step Functions パイプラインを起動
7. ユーザーに通知（任意）

**代替フロー:**
- 3a. ダウンロード失敗時、最大3回リトライ
- 4a. S3 アップロード失敗時、エラーログ記録しアラート送信

### UC-003: 既存会議への録画設定適用

**アクター:** ユーザー

**前提条件:**
- カレンダーに既存の会議がある
- 会議はまだ開始されていない

**基本フロー:**
1. ユーザーが会議一覧を表示
2. 対象の会議を選択
3. 「自動録画を有効にする」トグルをON
4. システムが Meet Space を取得/作成
5. auto-recording 設定を適用
6. 設定完了を表示

---

## 7. 受け入れ基準

### 7.1 機能テスト

- [ ] Google OAuth ログイン・ログアウトが正常に動作する
- [ ] カレンダーイベントの取得・作成が正常に動作する
- [ ] 自動録画設定が会議に適用される
- [ ] 録画完了後、自動的に分析パイプラインが起動する
- [ ] 分析結果が会議と紐付けて表示される

### 7.2 非機能テスト

- [ ] 1GB ファイルのダウンロード・アップロードが10分以内に完了する
- [ ] 同時10件の処理が正常に動作する
- [ ] 障害発生時にリトライが実行される
- [ ] エラー時にアラートが送信される

### 7.3 セキュリティテスト

- [ ] OAuth トークンが暗号化されて保存されている
- [ ] 不正なアクセスが拒否される
- [ ] 監査ログが記録されている
